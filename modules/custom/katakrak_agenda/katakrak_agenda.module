<?php
/**
 * @file
 * Code for the Katakrak Agenda feature.
 */

include_once 'katakrak_agenda.features.inc';

function katakrak_agenda_theme() {
  $path = drupal_get_path('module', 'katakrak_agenda');
  return array(
    'agenda_date' => array(
      'template' => 'agenda-date',
      'path' => $path . '/templates',
      'arguments' => array(
        'time' => NULL,
        'color' => '#2780af'
      )
    ),
  );
}

function katakrak_agenda_node_presave($node) {
  if ($node->type == 'ciclo' && $node->language != 'und') {
    $citas = array();
    $nids = array();
    foreach ($node->field_ciclo_actos['und'] as $nid) {
      $acto = node_load($nid['nid']);
      $translations = translation_node_get_translations($acto->tnid);
      if (!in_array($translations[$node->language]->nid, $nids)) {
        $citas[]['nid'] = $translations[$node->language]->nid;
        $nids[] = $translations[$node->language]->nid;
      }
    }
    $node->field_ciclo_actos['und'] = $citas;
  }
}

function katakrak_agenda_node_load($nodes, $types) {
  if (count(array_intersect(array('event'), $types))) {
    foreach ($nodes as $node) {
      $ciclos = db_select('field_data_field_ciclo_actos', 'a')->condition('a.field_ciclo_actos_nid', $node->nid)->fields('a')->execute()->fetchAll();
      foreach ($ciclos as $ciclo_db) {
        $ciclo = node_load($ciclo_db->entity_id);
        if ($ciclo->language == $node->language) {
          $node->ciclo = $ciclo;
        }
      }
    }
  }
}