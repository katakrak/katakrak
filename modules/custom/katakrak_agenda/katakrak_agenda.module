<?php
/**
 * @file
 * Code for the Katakrak Agenda feature.
 */

include_once 'katakrak_agenda.features.inc';

function katakrak_agenda_theme() {
  $path = drupal_get_path('module', 'katakrak_agenda');
  return array(
    'agenda_date' => array(
      'template' => 'agenda-date',
      'path' => $path . '/templates',
      'arguments' => array(
        'time' => NULL,
        'color' => '#2780af'
      )
    ),
  );
}

function katakrak_agenda_init() {
//  $nodes = db_select('node', 'n')->condition('n.type', 'ciclo')->fields('n', array('nid'))->execute()->fetchAll();
//  foreach ($nodes as $nid) {
//    node_delete($nid->nid);
//  }
//  $terms_db = db_select('taxonomy_term_data', 't')->condition('vid', 9)->fields('t', array('tid'))->execute()->fetchAll();
//  foreach ($terms_db as $tid) {
//    $term = taxonomy_term_load($tid->tid);
//    $nodes = taxonomy_select_nodes($term->tid);
//    
//    $node = new stdClass;
//    $node->title = $term->name;
//    $node->type = 'ciclo';
//    $node->language = $term->language;
//    $node->field_ciclo_libros = $term->field_ciclo_libros;
//    
//    foreach ($nodes as $nid) {
//      $node->field_ciclo_actos['und'][]['nid'] = $nid;
//    }
//    $node->uid = 1;
//    node_save($node);
//    taxonomy_term_delete($tid->tid);
//  }
  
//    $nodes = db_select('node', 'n')->condition('n.type', 'event')->fields('n', array('nid'))->range(150,50)
//      ->execute()->fetchAll();
//    foreach ($nodes as $nid) {
//      $node = node_load($nid->nid);
//      $node->field_event_descripcion['und'][0]['value'] = $node->field_event_description['und'][0]['value'];
//      $node->field_event_descripcion['und'][0]['format'] = $node->field_event_description['und'][0]['format'];
//      node_save($node);
//    }
}

function katakrak_agenda_node_presave($node) {
  if ($node->type == 'ciclo' && $node->language != 'und') {
    $citas = array();
    $nids = array();
    foreach ($node->field_ciclo_actos['und'] as $nid) {
      $acto = node_load($nid['nid']);
      $translations = translation_node_get_translations($acto->tnid);
      if (!in_array($translations[$node->language]->nid, $nids)) {
        $citas[]['nid'] = $translations[$node->language]->nid;
        $nids[] = $translations[$node->language]->nid;
      }
    }
    $node->field_ciclo_actos['und'] = $citas;
  }
}