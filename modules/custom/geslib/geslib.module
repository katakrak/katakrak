<?php

include_once dirname(__FILE__) . '/geslib.api.inc';
include_once dirname(__FILE__) . '/lib/InetBookSearch.php';


/**
 * Implementation of hook_menu().
 */
function geslib_menu() {
  $items = array();
  $items['admin/commerce/geslib'] = array(
    'title' => 'Import Geslib File',
    'description' => 'Carga inicial del fichero de geslig.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('geslib_first_import_form'),
    'access callback' => 'user_access',
    'access arguments' => array('geslib_content import'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}


function geslib_first_import_form($form, &$form_state) {
  $geslib_dir = DRUPAL_ROOT.'/sites/default/files/geslib';
  $files = scandir(DRUPAL_ROOT.'/sites/default/files/geslib');
  foreach ($files as $key => $value) {
    if ($value != '.' AND $value != '..'){
      $options[$geslib_dir.'/'.$value] = $value;
    }
  }
  $form['geslib_file'] = array(
    '#type' => 'select',
    '#title' => 'Geslib File',
    '#options' => $options,
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  $form['borrar items'] = array(
    '#type' => 'submit',
    '#value' => 'Borrar todo',
  );
  
  return $form;
}

function geslib_first_import_form_submit($form, &$form_state) {
  if ($form_state['clicked_button']['#value'] == 'Borrar todo') {
    $batch = array(
      'title' => t('Eliminando todos los elementos'),
      'operations' => array(
        array('geslib_process_delete_categories', array()),
        array('geslib_process_delete_products', array()), 
        array('geslib_process_delete_nodes', array()),
      ),
      'finished' => 'geslib_process_finish',
      'file' => drupal_get_path('module', 'geslib').'/geslib.batch.inc',
    );
    batch_set($batch);
  }
  else {
    $batch = array(
      'title' => t('Importando artÃ­culos de geslib'),
      'operations' => array(
          array('geslib_process_read_file', array($form_state['values']['geslib_file'])),
          array('geslib_process_items', array('category', 25)), 
          array('geslib_process_items', array('publisher', 200)),
          array('geslib_process_items', array('author', 200)),
          array('geslib_process_items', array('product', 200)),
      ),
      'finished' => 'geslib_process_finish',
      'file' => drupal_get_path('module', 'geslib').'/geslib.batch.inc',
    );
    batch_set($batch);
  }
}

function geslib_cron() {
  $geslib_dir = DRUPAL_ROOT.'/sites/default/files/geslib';
  $files = scandir(DRUPAL_ROOT.'/sites/default/files/geslib');
  foreach ($files as $key => $value) {
    if ($value != '.' AND $value != '..'){
      $options[$geslib_dir.'/'.$value] = $value;
    }
  }
}

function geslib_init() {
  $geslib_dir = DRUPAL_ROOT.'/sites/default/files/geslib';
  $files_tmp = scandir($geslib_dir);
  
  $processed_files = db_select('geslib_log', 'g')->fields('g', array('imported_file'))->execute()->fetchCol();
  
  $files = array();
  foreach ($files_tmp as $value) {
    if ($value != '.'&& $value != '..' && !in_array($value, $processed_files)){
      $files[] = $value;
    }
  }
  $result = db_select('queue', 'q')->fields('q')->execute()->fetchAll();
  $file_to_process = array_shift($files);
//  dpm(unserialize($result[0]->data));
//  dpm($files);
}